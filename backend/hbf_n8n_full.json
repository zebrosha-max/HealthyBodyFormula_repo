{
  "name": "HBF Smart Logger (Full Flow)",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        380,
        300
      ],
      "webhookId": "hbf-webhook"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.message ? ($json.message.text && $json.message.text.startsWith('/') ? 'command' : 'message') : 'callback' }}",
        "rules": {
          "rules": [
            {
              "value2": "command",
              "output": 0
            },
            {
              "value2": "message",
              "output": 1
            },
            {
              "value2": "callback",
              "output": 2
            }
          ]
        }
      },
      "id": "router",
      "name": "Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        600,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–≤–æ–π –ø—Ä–∏–µ–º –ø–∏—â–∏.\n\nüì∏ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –µ–¥—ã\nüé§ –ó–∞–ø–∏—à–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ\nüìù –ò–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º",
        "additionalFields": {}
      },
      "id": "welcome-msg",
      "name": "Welcome Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        820,
        100
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.message.voice ? 'voice' : ($json.message.photo ? 'photo' : 'text') }}",
        "rules": {
          "rules": [
            {
              "value2": "text",
              "output": 0
            },
            {
              "value2": "photo",
              "output": 1
            },
            {
              "value2": "voice",
              "output": 2
            }
          ]
        }
      },
      "id": "content-type",
      "name": "Content Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        820,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "sendQuery": true,
        "queryParameters": {
          "key": "={{ $env.GOOGLE_API_KEY }}"
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"–¢—ã –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏ –≤–µ—Ä–Ω–∏ JSON. –§–æ—Ä–º–∞—Ç: {\\\"dish\\\": \\\"–ù–∞–∑–≤–∞–Ω–∏–µ\\\", \\\"calories\\\": 0, \\\"protein\\\": 0, \\\"fat\\\": 0, \\\"carbs\\\": 0}. –ï—Å–ª–∏ –µ–¥—ã –Ω–µ—Ç, –≤–µ—Ä–Ω–∏ {\\\"error\\\": \\\"true\\\". –¢–µ–∫—Å—Ç: {{ $json.message.text }}\"\n    }]
  }]
}",
        "options": {}
      },
      "id": "ai-text",
      "name": "AI Analyze (Text)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1100,
        200
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": "={{ $json.message.photo[$json.message.photo.length - 1].file_id }}"
      },
      "id": "get-photo",
      "name": "Get Photo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1000,
        360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "sendQuery": true,
        "queryParameters": {
          "key": "={{ $env.GOOGLE_API_KEY }}"
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={\n  \"contents\": [{\n    \"parts\": [
      {
        \"text\": \"–¢—ã –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –û—Ü–µ–Ω–∏ –ë–ñ–£–ö –ø–æ —Ñ–æ—Ç–æ. –í–µ—Ä–Ω–∏ JSON: {\\\"dish\\\": \\\"–ù–∞–∑–≤–∞–Ω–∏–µ\\\", \\\"calories\\\": 0, \\\"protein\\\": 0, \\\"fat\\\": 0, \\\"carbs\\\": 0}.\"      },
      {
        \"inline_data\": {
          \"mime_type\": \"image/jpeg\",
          \"data\": \"{{ $binary.data.data }}"
        }
      }
    ]
  }]
}",
        "options": {}
      },
      "id": "ai-photo",
      "name": "AI Analyze (Photo)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1220,
        360
      ]
    },
    {
      "parameters": {
        "table": "food_logs",
        "columns": "user_id, dish_name, calories, protein, fat, carbs, log_text, status",
        "options": {}
      },
      "id": "db-insert-pending",
      "name": "DB Insert (Pending)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1500,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $node["Telegram Trigger"].json.message.chat.id }}",
        "text": "=üçΩ {{ $json.dish_name }}\nüî• {{ $json.calories }} –∫–∫–∞–ª\n(–ë: {{ $json.protein }} | –ñ: {{ $json.fat }} | –£: {{ $json.carbs }})",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            [
              {
                "text": "‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å",
                "callback_data": "=confirm_{{ $json.id }}"
              },
              {
                "text": "‚ùå –û—Ç–º–µ–Ω–∞",
                "callback_data": "=delete_{{ $json.id }}"
              }
            ]
          ]
        },
        "additionalFields": {}
      },
      "id": "ask-confirm",
      "name": "Ask Confirmation",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1700,
        300
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.callback_query.data.split('_')[0] }}",
        "rules": {
          "rules": [
            {
              "value2": "confirm",
              "output": 0
            },
            {
              "value2": "delete",
              "output": 1
            }
          ]
        }
      },
      "id": "callback-router",
      "name": "Callback Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        820,
        500
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "table": "food_logs",
        "updateKey": "id",
        "columns": "status",
        "options": {}
      },
      "id": "db-confirm",
      "name": "DB Confirm",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1100,
        480
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "table": "food_logs",
        "updateKey": "id",
        "options": {}
      },
      "id": "db-delete",
      "name": "DB Delete",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1100,
        640
      ]
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.callback_query.message.chat.id }}",
        "messageId": "={{ $json.callback_query.message.message_id }}",
        "text": "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫!",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            [
              {
                "text": "üì± –û—Ç–∫—Ä—ã—Ç—å –¥–Ω–µ–≤–Ω–∏–∫",
                "url": "https://t.me/HealthyBodyFormula_bot/hbf_app?startapp=screen_profile"
              }
            ]
          ]
        },
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "reply-saved",
      "name": "Reply Saved",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1320,
        480
      ]
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $json.callback_query.message.chat.id }}",
        "messageId": "={{ $json.callback_query.message.message_id }}"
      },
      "id": "delete-msg",
      "name": "Delete Msg",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1320,
        640
      ]
    },
    {
      "parameters": {
        "mode": "json",
        "json": "={\n  \"user_id\": {{ $node[\"Telegram Trigger\"].json.message.chat.id }},
  \"status\": \"pending\",
  \"log_text\": \"{{ $node[\"Telegram Trigger\"].json.message.text || 'Photo/Voice' }}\",
  \"dish_name\": \"{{ $json.candidates[0].content.parts[0].text.extractJson().dish }}\",
  \"calories\": {{ $json.candidates[0].content.parts[0].text.extractJson().calories }},
  \"protein\": {{ $json.candidates[0].content.parts[0].text.extractJson().protein }},
  \"fat\": {{ $json.candidates[0].content.parts[0].text.extractJson().fat }},
  \"carbs\": {{ $json.candidates[0].content.parts[0].text.extractJson().carbs }}
}"
      },
      "id": "prepare-data",
      "name": "Prepare Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "mode": "json",
        "json": "={\n  \"id\": \"{{ $node[\"Telegram Trigger\"].json.callback_query.data.split('_')[1] }}\",
  \"status\": \"confirmed\"
}"
      },
      "id": "prep-confirm",
      "name": "Prep Confirm",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        960,
        480
      ]
    },
    {
      "parameters": {
        "mode": "json",
        "json": "={\n  \"id\": \"{{ $node[\"Telegram Trigger\"].json.callback_query.data.split('_')[1] }}\"\n}"
      },
      "id": "prep-delete",
      "name": "Prep Delete",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        960,
        640
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "Welcome Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Content Type",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Callback Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Content Type": {
      "main": [
        [
          {
            "node": "AI Analyze (Text)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Photo": {
      "main": [
        [
          {
            "node": "AI Analyze (Photo)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Analyze (Text)": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Analyze (Photo)": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data": {
      "main": [
        [
          {
            "node": "DB Insert (Pending)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB Insert (Pending)": {
      "main": [
        [
          {
            "node": "Ask Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Callback Router": {
      "main": [
        [
          {
            "node": "Prep Confirm",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Confirm": {
      "main": [
        [
          {
            "node": "DB Confirm",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Delete": {
      "main": [
        [
          {
            "node": "DB Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB Confirm": {
      "main": [
        [
          {
            "node": "Reply Saved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB Delete": {
      "main": [
        [
          {
            "node": "Delete Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}